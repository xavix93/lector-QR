<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lector QR ‚Ä¢ GitHub Pages</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>

<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:860px;margin:auto;padding:18px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px dashed #334155}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button,.btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer;text-decoration:none}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ GitHub Pages</h1>

  <div class="card" id="card-scan">
    <div id="reader"></div>

    <div class="row">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
      <input id="manual" placeholder="Pegar token y Enter" />
    </div>

    <div id="out"></div>

    <div class="row" style="margin-top:10px">
      <a id="dl-used-json" class="btn" download="usados-local.json">Descargar USADOS (JSON)</a>
      <a id="dl-used-csv"  class="btn" download="usados-local.csv">Descargar USADOS (CSV)</a>
    </div>

    <div style="margin-top:8px;color:#9ca3af;font-size:12px">
      Este sitio lee <code>tokens.json</code> del repo/project page. Los ‚Äúusados‚Äù se guardan
      localmente (este navegador). S√∫belos al repo cuando quieras sincronizar.
    </div>
  </div>
</div>

<!-- ===== CARGADOR ROBUSTO DE LA LIBRER√çA (local -> CDN1 -> CDN2) ===== -->
<script>
  // Base del proyecto: funciona en user page (/) y project page (/mi-repo/)
  const BASE = location.pathname.replace(/[^\/]+$/, '');  // carpeta actual
  const LOCAL_LIB = BASE + "vendor/html5-qrcode.min.js";  // cambia si lo pones en otro lado

  // Intentos de carga
  const H5QR_CANDIDATES = [
    LOCAL_LIB,
    "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
    "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"
  ];

  // Inyecta un <script> y espera a que cargue
  function injectScript(url){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = url + "?v=" + Date.now();  // cache-busting para Safari/iOS
      s.defer = true;
      s.crossOrigin = "anonymous";
      s.onload = ()=>resolve(true);
      s.onerror = ()=>reject(new Error("No carg√≥ "+url));
      document.head.appendChild(s);
    });
  }

  // Comienza la carga en cuanto abre la p√°gina (no bloquea la UI)
  const libReady = (async ()=>{
    for (const url of H5QR_CANDIDATES){
      try{
        await injectScript(url);
        if (window.Html5Qrcode) return true;
      }catch(_){ /* probar siguiente */ }
    }
    return false;
  })();

  // Espera/valida que la lib est√© disponible
  async function ensureLib(){
    const ok = await libReady;
    if (!ok) throw new Error("Librer√≠a de QR no se carg√≥");
    for (let i=0;i<50;i++){ // ~10s de gracia
      if (window.Html5Qrcode) return true;
      await new Promise(r=>setTimeout(r,200));
    }
    throw new Error("Librer√≠a de QR no se carg√≥");
  }
</script>

<!-- ===== L√ìGICA DEL LECTOR/VALIDADOR ===== -->
<script>
let html5 = null, cameras = [], camIdx = 0, last = "", lastAt = 0;
let allowMap = {};              // tokens permitidos desde tokens.json
let usedLocal = {};             // usados guardados en este navegador

const out = (m,c)=>document.getElementById("out").innerHTML =
  `<div class="status ${c}">${m}</div>`;

// tokens.json en la misma carpeta que index.html
const TOKENS_URL = BASE + "tokens.json";

// Cargar tokens.json
async function loadTokens(){
  const r = await fetch(TOKENS_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("No pude leer tokens.json ("+r.status+")");
  const j = await r.json();
  if(!j.tokens || typeof j.tokens !== "object") throw new Error("tokens.json con formato inv√°lido");
  allowMap = j.tokens; // {TOKEN: true/false}  (true = YA usado, false = disponible)
}

// Utilidades de descarga de usados
function blobDownload(el, name, text){
  el.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
  el.download = name;
}
function refreshDownloads(){
  const j = JSON.stringify(usedLocal, null, 2);
  blobDownload(document.getElementById("dl-used-json"), "usados-local.json", j);
  const csv = "token,usado_local\n" + Object.keys(usedLocal).map(t=>`${t},SI`).join("\n");
  blobDownload(document.getElementById("dl-used-csv"), "usados-local.csv", csv);
}

// Validar un token
function validateToken(token){
  token = (token||"").trim();
  if(!token) return;
  const exists = Object.prototype.hasOwnProperty.call(allowMap, token);
  if(!exists) return out("‚ùå INV√ÅLIDA (token no est√° en la lista)","bad");

  const yaRepo  = allowMap[token] === true;   // marcado en tokens.json
  const yaLocal = usedLocal[token] === true;  // marcado en este navegador
  if (yaRepo || yaLocal) return out("‚ö†Ô∏è YA utilizada","warn");

  // marcar localmente como usado
  usedLocal[token] = true;
  localStorage.setItem("qr_usados", JSON.stringify(usedLocal));
  refreshDownloads();
  return out("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
}

// Callback del escaneo
function onScanSuccess(text){
  const now = Date.now();
  if(text===last && (now-lastAt)<1500) return;  // antirrebote
  last = text; lastAt = now;
  validateToken(text);
  try{ navigator.vibrate && navigator.vibrate(80); }catch(_){}
}

// C√°mara
async function start(){
  try{
    if (!location.protocol.startsWith("https")) {
      out("‚ùå Se requiere HTTPS para usar la c√°mara.", "bad"); return;
    }
    await ensureLib();

    if (!html5) html5 = new Html5Qrcode("reader");
    cameras = await Html5Qrcode.getCameras();
    if(!cameras.length) throw new Error("No hay c√°mara disponible");

    const id = cameras[camIdx]?.id || cameras[0].id;
    await html5.start({deviceId:{exact:id}}, {fps:12, qrbox:250}, onScanSuccess);
    out("C√°mara iniciada","ok");
  }catch(e){
    out("‚ùå No se pudo iniciar la c√°mara: "+e.message, "bad");
  }
}
async function stop(){ try{ await html5?.stop(); html5?.clear(); out("C√°mara detenida","warn"); }catch(_){ } }
async function flip(){
  if(!cameras.length) cameras = await Html5Qrcode.getCameras();
  if(!cameras.length) return out("No hay c√°maras","bad");
  camIdx = (camIdx+1) % cameras.length;
  await stop(); await start();
}

// Entrada manual
document.getElementById("manual").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v = e.target.value.trim();
    if(v) validateToken(v);
    e.target.select();
  }
});

// Inicializaci√≥n
(async ()=>{
  try{
    // cargar usados locales guardados previamente
    usedLocal = JSON.parse(localStorage.getItem("qr_usados")||"{}");
    refreshDownloads();

    await loadTokens();
    out("Lista de tokens cargada. Listo para escanear.","ok");
  }catch(e){
    out("‚ùå Error cargando tokens: "+e.message, "bad");
  }
})();
document.getElementById("start").onclick = start;
document.getElementById("stop").onclick  = stop;
document.getElementById("flip").onclick  = flip;
</script>
</body>
</html>
