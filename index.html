<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector QR ‚Ä¢ Entradas</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb;margin:0}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-top:16px}
  h1{font-size:20px;margin:0 0 8px}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  .muted{color:#9ca3af;font-size:12px;margin-top:6px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer}
  #reader{width:100%;min-height:320px}
  .cfg{display:flex;gap:8px;align-items:center;margin-top:8px}
  input[type=text]{flex:1;min-width:0;padding:8px;border-radius:10px;border:1px solid #374151;background:#111827;color:#e5e7eb}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ Validador 1-uso</h1>
  <div class="card">
    <div class="cfg">
      <label for="validator">Endpoint:</label>
      <input id="validator" type="text" placeholder="Pega aqu√≠ tu URL /exec de Apps Script" />
      <button id="save">Guardar</button>
    </div>
    <div id="reader"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
    </div>
    <div class="muted">Escanea y validamos contra el endpoint. Necesita HTTPS para usar la c√°mara (iPhone lo exige).</div>
  </div>
  <div id="out" class="card"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let VALIDATOR_BASE = localStorage.getItem("validatorBase") || "";
let lastText="", lastAt=0, html5QrCode, currentCamIndex=0, cameras=[];

document.getElementById("validator").value = VALIDATOR_BASE;
document.getElementById("save").onclick = () => {
  VALIDATOR_BASE = document.getElementById("validator").value.trim();
  localStorage.setItem("validatorBase", VALIDATOR_BASE);
  paint("‚úÖ Endpoint guardado", "ok");
};

function beep(ms=120){
  try{const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination); o.frequency.value=880; o.start();
      setTimeout(()=>{o.stop();ctx.close()},ms);}catch(_){}
}
function paint(msg, cls){ document.getElementById("out").innerHTML = `<div class="status ${cls}">${msg}</div>`; }
function urlFromScan(text){
  text = text.trim();
  if (!VALIDATOR_BASE) throw new Error("Configura primero el endpoint (URL /exec) en la caja superior.");
  if(/^https?:\/\//i.test(text)) return text;
  if (/(^|[?&])n=.+&c=.+/i.test(text)) return `${VALIDATOR_BASE}?${text.replace(/^.*\?/,'')}`;
  if (text.includes("|")){ const [n,c]=text.split("|"); return `${VALIDATOR_BASE}?n=${encodeURIComponent(n)}&c=${encodeURIComponent(c)}`; }
  // por defecto tratamos todo el contenido como 'c' (token)
  return `${VALIDATOR_BASE}?c=${encodeURIComponent(text)}`;
}
async function validate(decoded){
  try{
    const url = urlFromScan(decoded);
    const r = await fetch(url, {cache:"no-store"}); const t = (await r.text()).toLowerCase();
    if (t.includes("v√°lida") && !t.includes("ya")) paint("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
    else if (t.includes("ya") && t.includes("utilizada")) paint("‚ö†Ô∏è YA utilizada","warn");
    else if (t.includes("inv√°lida") || t.includes("invalida")) paint("‚ùå INV√ÅLIDA","bad");
    else { paint("‚ÑπÔ∏è Respuesta recibida", "bad"); console.log(t); }
  }catch(e){ paint("‚ùå Error: "+e.message,"bad"); }
}
function onScanSuccess(text){
  const now=Date.now(); if(text===lastText && (now-lastAt)<1500) return; lastText=text; lastAt=now;
  navigator.vibrate && navigator.vibrate(100); beep(); validate(text);
}
async function start(){
  try{
    if(!html5QrCode) html5QrCode=new Html5Qrcode("reader");
    cameras = await Html5Qrcode.getCameras();
    if(!cameras?.length) throw new Error("No hay c√°mara disponible");
    const id=cameras[currentCamIndex].id;
    await html5QrCode.start({deviceId:{exact:id}}, {fps:12, qrbox:{width:240,height:240}}, onScanSuccess);
  }catch(e){ paint("‚ùå "+e.message,"bad"); }
}
async function stop(){ try{ await html5QrCode?.stop(); }catch(_){ } }
async function flip(){
  if(!cameras.length) cameras = await Html5Qrcode.getCameras();
  if(!cameras.length) return paint("No hay c√°maras","bad");
  currentCamIndex = (currentCamIndex+1) % cameras.length;
  await stop(); await start();
}
document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;
document.getElementById("flip").onclick=flip;
</script>
</body>
</html>
