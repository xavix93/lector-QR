<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì∑ Lector QR ‚Ä¢ GitHub Pages</title>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:860px;margin:auto;padding:18px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px dashed #334155}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;text-decoration:none}
  .muted{color:#9ca3af;font-size:12px}
</style>

<script>
/* 1) Cargar html5-qrcode con fallback y timeout */
function loadHtml5Qrcode(){
  return new Promise((resolve,reject)=>{
    if (window.Html5Qrcode) return resolve('ya cargada');
    const CDNs = [
      "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
      "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.10/html5-qrcode.min.js"
    ];
    let i = 0, done = false;
    const t = setTimeout(()=>!done && reject(new Error("timeout cargando html5-qrcode")), 9000);
    (function inject(){
      const s = document.createElement("script");
      s.src = CDNs[i] + "?v=" + Date.now();  // anti-cach√©
      s.defer = true;
      s.crossOrigin = "anonymous";
      s.onload = () => { done = true; clearTimeout(t); resolve(s.src); };
      s.onerror = () => { if (++i < CDNs.length) inject(); else { clearTimeout(t); reject(new Error("fall√≥ cargar librer√≠a en todos los CDNs")); } };
      document.head.appendChild(s);
    })();
  });
}
</script>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ GitHub Pages</h1>

  <div class="card">
    <!-- ‚úÖ Mensaje arriba del lector -->
    <div id="out" class="status warn">Cargando librer√≠a y tokens‚Ä¶</div>

    <div id="reader"></div>

    <div class="row">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
      <input id="manual" placeholder="Pegar token y Enter" />
    </div>

    <div class="row" style="margin-top:10px">
      <button id="reset-local">Borrar USADOS (este dispositivo)</button>
      <button id="remove-one">Borrar un token‚Ä¶</button>
      <button id="force-reload">Recargar lista</button>
    </div>
    <div id="stats" class="muted" style="margin-top:6px"></div>

    <div class="row" style="margin-top:10px">
      <a id="dl-used-json" class="btn" download="usados-local.json">Descargar USADOS (JSON)</a>
      <a id="dl-used-csv"  class="btn" download="usados-local.csv">Descargar USADOS (CSV)</a>
    </div>
    <div class="muted" style="margin-top:8px">
      Este sitio lee <code>tokens.json</code> del repo. Los ‚Äúusados‚Äù se guardan localmente (este navegador).
      S√∫belos al repo cuando quieras para sincronizar.
    </div>
  </div>
</div>

<script>
/* 2) CONFIG: ruta del JSON en tu repo
   - Si est√° junto a index.html: */
const TOKENS_URL_BASE = "./tokens.json";
/*   - Si est√° en /lector-QR/tokens.json:
const TOKENS_URL_BASE = "/lector-QR/tokens.json";
*/

let html5, cameras=[], camIdx=0, last="", lastAt=0;
let allowMap = {};   // token -> true/false (true = ya usado / listado como usado)
let usedLocal = {};  // marcados en este navegador

const out = (m,c)=>{ const el=document.getElementById("out"); el.className="status "+c; el.textContent=m; };

async function loadTokens(bust=false){
  const url = TOKENS_URL_BASE + (bust ? `?v=${Date.now()}` : `?v=1`);
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("No pude leer tokens.json ("+r.status+")");
  const j = await r.json();
  if(!j.tokens || typeof j.tokens !== "object") throw new Error("Formato inv√°lido de tokens.json");
  allowMap = j.tokens; // { "TOKEN": false/true, ... }
}

/* Descargas de usados locales */
function blobDownload(el, name, text){
  el.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
  el.download = name;
}
function refreshDownloads(){
  const j = JSON.stringify(usedLocal, null, 2);
  blobDownload(document.getElementById("dl-used-json"), "usados-local.json", j);
  const csv = "token,usado_local\n" + Object.keys(usedLocal).map(t => `${t},SI`).join("\n");
  blobDownload(document.getElementById("dl-used-csv"), "usados-local.csv", csv);
}
function updateStats(){
  try{
    const n = Object.keys(usedLocal || {}).length;
    document.getElementById("stats").textContent = `Usados en este dispositivo: ${n}`;
  }catch(_){}
}

/* Validar un token */
function validateToken(token){
  token = String(token||"").trim();
  if(!token) return out("Ingresa o escanea un token.","warn");

  const exists = Object.prototype.hasOwnProperty.call(allowMap, token);
  if(!exists) { out("‚ùå INV√ÅLIDA (token no en lista)","bad"); return; }

  const ya = allowMap[token] === true || usedLocal[token] === true;
  if(ya) { out("‚ö†Ô∏è YA utilizada","warn"); return; }

  // marcar localmente (solo en este dispositivo)
  usedLocal[token] = true;
  localStorage.setItem("qr_usados", JSON.stringify(usedLocal));
  refreshDownloads();
  updateStats();
  out("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
}

/* Escaneo */
function onScanSuccess(text){
  const now=Date.now(); if(text===last && (now-lastAt)<1500) return; last=text; lastAt=now;
  validateToken(text);
}

/* C√°mara */
async function start(){
  try{
    if(!window.Html5Qrcode){ return out("‚ùå Librer√≠a de QR no se carg√≥","bad"); }
    if(!html5) html5 = new Html5Qrcode("reader");
    cameras = await Html5Qrcode.getCameras();
    if(!cameras.length) throw new Error("No hay c√°mara disponible o sin permiso");
    await html5.start({deviceId:{exact:cameras[camIdx].id}}, {fps:12, qrbox:250}, onScanSuccess);
    out("C√°mara iniciada","ok");
  }catch(e){ out("‚ùå No se pudo iniciar la c√°mara: "+e.message,"bad"); }
}
async function stop(){ try{ await html5?.stop(); html5?.clear(); out("C√°mara detenida","warn"); }catch(_){} }
async function flip(){
  if(!cameras.length) cameras = await Html5Qrcode.getCameras();
  if(!cameras.length) return out("No hay c√°maras","bad");
  camIdx = (camIdx+1) % cameras.length;
  await stop(); await start();
}

/* Manual */
document.getElementById("manual").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v = e.target.value.trim();
    if(v) validateToken(v);
    e.target.select();
  }
});

/* Botones de mantenimiento */
document.getElementById("reset-local").onclick = () => {
  if(!confirm("¬øBorrar TODOS los USADOS guardados en ESTE dispositivo?")) return;
  localStorage.removeItem("qr_usados");
  usedLocal = {};
  refreshDownloads(); updateStats();
  out("Usos locales borrados en este dispositivo.", "ok");
};
document.getElementById("remove-one").onclick = () => {
  const tok = prompt("Pega el token que deseas desmarcar (quitar de USADOS locales):");
  if(!tok) return;
  const t = tok.trim();
  if (t in usedLocal) {
    delete usedLocal[t];
    localStorage.setItem("qr_usados", JSON.stringify(usedLocal));
    refreshDownloads(); updateStats();
    out("Token desmarcado en este dispositivo.", "ok");
  } else {
    out("Ese token no estaba marcado como usado en este dispositivo.", "warn");
  }
};
document.getElementById("force-reload").onclick = async () => {
  try{
    await loadTokens(true); // fuerza bust de cach√©
    out("Lista de tokens recargada desde GitHub.", "ok");
  }catch(e){
    out("Error recargando lista: " + e.message, "bad");
  }
};

/* 3) Inicializaci√≥n */
(async ()=>{
  try{
    usedLocal = JSON.parse(localStorage.getItem("qr_usados")||"{}");
    refreshDownloads(); updateStats();

    // cargar librer√≠a y tokens en paralelo
    await Promise.all([ loadHtml5Qrcode(), loadTokens(true) ]);
    out("‚úÖ Listo: librer√≠a y tokens cargados. Toca ‚ÄúIniciar c√°mara‚Äù.","ok");
  }catch(e){
    out("‚ùå Error al iniciar: "+e.message,"bad");
    console.error(e);
  }
})();

document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;
document.getElementById("flip").onclick=flip;
</script>
</body>
</html>
