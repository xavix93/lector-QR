<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector QR ‚Ä¢ C√°mara (robusto)</title>
<style>
  :root{color-scheme: dark;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb;margin:0}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-top:16px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:#9ca3af;font-size:12px;margin-top:6px}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center;white-space:pre-wrap}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer}
  #reader{width:100%;min-height:320px}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  #diag{font-size:12px;color:#9ca3af;margin-top:8px;white-space:pre-wrap}
  input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ C√°mara (robusto)</h1>
  <div class="card">
    <div id="reader"></div>
    <div class="row">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
    </div>
    <div id="diag" class="muted"></div>
    <div class="muted">iOS/Android requieren HTTPS para usar la c√°mara en el navegador. Evita abrir dentro de WhatsApp/Instagram; usa Safari/Chrome.</div>
  </div>

  <div class="card">
    <h1>Prueba manual (sin c√°mara)</h1>
    <div class="row">
      <input id="manual" type="text" placeholder="Pega aqu√≠ un token o URL de prueba y presiona Validar">
      <button id="btnManual">Validar</button>
    </div>
  </div>

  <div id="out" class="card"></div>
</div>

<!-- Cambia aqu√≠ tu /exec de Apps Script -->
<script>
const VALIDATOR_BASE = "https://script.google.com/macros/s/AKfycbzQ5_g70DZ-ThfPOafiFj1AjX9Yta04srnvdv6E7sxTZ4irbHSsV5j6A8LbL96HDC3R3A/exec";
</script>

<!-- Fijamos versi√≥n del lector -->
<script src="https://unpkg.com/html5-qrcode@2.3.10"></script>
<script>
function beep(ms=120){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value=880; o.start();
    setTimeout(()=>{o.stop();ctx.close()},ms);
  }catch(_){}
}
function paint(msg, cls){ document.getElementById("out").innerHTML = `<div class="status ${cls}">${msg}</div>`; }
function diag(msg){ const d=document.getElementById("diag"); d.textContent = (d.textContent? d.textContent+"\n":"") + msg; }

// Construye URL hacia el validador
function buildUrlFromScan(text){
  text = (text||"").trim();
  if(!VALIDATOR_BASE) throw new Error("Falta configurar VALIDATOR_BASE.");
  if(/^https?:\/\//i.test(text)) return text; // el QR ya trae una URL
  if (/(^|[?&])n=.+&c=.+/i.test(text)) return `${VALIDATOR_BASE}?${text.replace(/^.*\?/,'')}`; // soporta n&c
  if (text.includes("|")){ const [n,c]=text.split("|"); return `${VALIDATOR_BASE}?n=${encodeURIComponent(n)}&c=${encodeURIComponent(c)}`; }
  return `${VALIDATOR_BASE}?c=${encodeURIComponent(text)}`; // por defecto: token
}

// Normaliza respuesta: quita HTML y acentos
function normalizeText(s){
  let t = String(s||"");
  t = t.replace(/<script[\s\S]*?<\/script>/gi,'')
       .replace(/<style[\s\S]*?<\/style>/gi,'')
       .replace(/<[^>]+>/g,' ')
       .replace(/\s+/g,' ')
       .trim();
  t = t.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return t.toUpperCase();
}

async function validate(decoded){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), 10000); // 10s timeout
  try{
    const url = buildUrlFromScan(decoded);
    diag("Validando: " + url);
    const r = await fetch(url, {cache:"no-store", signal: controller.signal});
    const raw = await r.text();
    const T = normalizeText(raw); // "VALIDA", "YA_USADA", "INVALIDA", "ERR: ..."

    const isErr   = /\bERR/.test(T) || /FALTA\s*\?\s*C=/.test(T);
    const isUsed  = /\bYA[_\s]*USADA\b/.test(T) || /\bYA[_\s]*UTILIZADA\b/.test(T);
    const isInv   = /\bINVALIDA\b/.test(T);
    const isOk    = /\bVALIDA\b/.test(T) && !isInv && !isUsed;

    if (isOk)      paint("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
    else if (isUsed)  paint("‚ö†Ô∏è YA usada","warn");
    else if (isInv)   paint("‚ùå INV√ÅLIDA","bad");
    else if (isErr)   paint("‚ùå Error del validador:\n"+raw,"bad");
    else              paint("‚ÑπÔ∏è Respuesta del servidor:\n"+raw,"bad");

    navigator.vibrate && navigator.vibrate(80); beep();
  }catch(e){
    if (e.name === 'AbortError') paint("‚ùå Sin respuesta (timeout). Revisa conexi√≥n/URL).","bad");
    else paint("‚ùå Error: "+e.message,"bad");
    diag("Fetch error: " + e.name + " - " + e.message);
  } finally {
    clearTimeout(timer);
  }
}

let lastText="", lastAt=0, html5QrCode, cameras=[], currentCamIndex=0;

function onScanSuccess(text){
  const now=Date.now();
  if(text===lastText && (now-lastAt)<1500) return;
  lastText=text; lastAt=now;
  validate(text);
}

// Intenta arrancar por deviceId, si falla prueba facingMode
async function start(){
  try{
    // Chequeos r√°pidos
    diag("isSecureContext=" + (window.isSecureContext ? "true":"false"));
    diag("mediaDevices=" + (!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)));
    if (!window.isSecureContext) {
      paint("‚ùå Debes abrir esta p√°gina por HTTPS (no file://).","bad");
      return;
    }

    // Pide permiso de antemano (mejor UX en iOS)
    try{
      await navigator.mediaDevices.getUserMedia({ video: true });
      diag("Permiso de c√°mara otorgado.");
    }catch(e){
      diag("getUserMedia preliminar: " + e.name + " - " + e.message);
      // seguimos igual; algunos navegadores piden permiso al iniciar html5-qrcode
    }

    if(!html5QrCode) html5QrCode=new Html5Qrcode("reader");

    // 1) Intento por deviceId (si hay)
    cameras = await Html5Qrcode.getCameras();
    diag("C√°maras detectadas: " + (cameras?.length || 0));
    if (cameras && cameras.length){
      const id=cameras[currentCamIndex]?.id || cameras[0].id;
      try{
        await html5QrCode.start({deviceId:{exact:id}}, {fps:12, qrbox:{width:240,height:240}}, onScanSuccess);
        paint("C√°mara iniciada (deviceId)","ok");
        return;
      }catch(e){
        diag("start(deviceId) fall√≥: " + e.message);
      }
    }

    // 2) Fallback iOS: facingMode environment
    try{
      await html5QrCode.start({facingMode:"environment"}, {fps:12, qrbox:{width:240,height:240}}, onScanSuccess);
      paint("C√°mara iniciada (facingMode: environment)","ok");
      return;
    }catch(e2){
      diag("start(facingMode) fall√≥: " + e2.message);
      throw e2; // caer al catch principal
    }
  }catch(e){
    paint("‚ùå No se pudo iniciar la c√°mara: " + e.message, "bad");
    diag("Error start(): " + e.name + " - " + e.message);
    if (/NotAllowedError/i.test(e.name) || /Permission|denied/i.test(e.message)){
      diag("Dale permiso de c√°mara en el navegador (Ajustes > Safari/Chrome > C√°mara > Permitir).");
    }
    if (!window.isSecureContext){
      diag("Debes alojar la p√°gina en HTTPS (GitHub Pages, Netlify, Vercel, etc.).");
    }
  }
}

async function stop(){
  try{ await html5QrCode?.stop(); paint("C√°mara detenida","warn"); }catch(_){}
}
async function flip(){
  if(!cameras || !cameras.length){
    cameras = await Html5Qrcode.getCameras();
    if(!cameras || !cameras.length) return paint("No hay c√°maras para cambiar","bad");
  }
  currentCamIndex = (currentCamIndex+1) % cameras.length;
  await stop(); await start();
}

// Botones
document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;
document.getElementById("flip").onclick=flip;

// Validaci√≥n manual
document.getElementById("btnManual").onclick=()=>{
  const t = document.getElementById("manual").value.trim();
  if(!t) return paint("Escribe un token o URL primero.","warn");
  validate(t);
};
</script>
</body>
</html>
