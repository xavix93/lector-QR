<script>
(function loadH5QR(){
  const urls = [
    "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js",
    "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
  ];
  let i = 0;
  (function inject(){
    const s = document.createElement("script");
    s.src = urls[i] + "?v=1"; // cache-busting
    s.defer = true;
    s.onload = () => console.log("html5-qrcode cargado:", s.src);
    s.onerror = () => { if (++i < urls.length) inject(); else console.error("No se pudo cargar html5-qrcode"); };
    document.head.appendChild(s);
  })();
})();
</script>

<script>
  window.addEventListener("load", async () => {
    if (!window.Html5Qrcode) { console.error("Html5Qrcode no disponible"); return; }
    const html5 = new Html5Qrcode("reader");
    const cams = await Html5Qrcode.getCameras();
    await html5.start({ deviceId: { exact: cams[0].id } }, { fps: 12, qrbox: 250 },
      (text) => console.log("QR:", text),
      (err)  => console.log("scan err:", err)
    );
  });
</script>


<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üì∑ Lector QR ‚Ä¢ GitHub Pages</title>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:860px;margin:auto;padding:18px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px dashed #334155}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button,a.btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer;text-decoration:none}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  .muted{color:#9ca3af;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ GitHub Pages</h1>

  <div class="card">
    <div id="reader"></div>

    <div class="row">
      <button id="start" disabled>Iniciar c√°mara</button>
      <button id="stop" disabled>Detener</button>
      <button id="flip" disabled>Cambiar c√°mara</button>
      <input id="manual" placeholder="Pegar token y Enter"/>
    </div>

    <div id="out" class="status warn">Cargando librer√≠a y tokens‚Ä¶</div>

    <div class="row" style="margin-top:10px">
      <a id="dl-used-json" class="btn" download="usados-local.json">Descargar USADOS (JSON)</a>
      <a id="dl-used-csv"  class="btn" download="usados-local.csv">Descargar USADOS (CSV)</a>
    </div>

    <p class="muted" style="margin-top:8px">
      Este sitio lee <code>tokens.json</code> del repo. Los ‚Äúusados‚Äù se guardan localmente (este navegador).  
      Para sincronizar globalmente, descarga y s√∫belos a tu repo cuando quieras.
    </p>
  </div>
</div>

<!-- 1) Librer√≠a local (estable) -->
<script src="./vendor/html5-qrcode.min.js"></script>
<!-- 2) Fallback CDN si la local fallara (raro, pero por si acaso) -->
<script>
(function ensureH5QR(){
  if (window.Html5Qrcode) return;
  const srcs = [
    "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
    "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"
  ];
  let i=0;
  function add(){
    const s=document.createElement("script");
    s.src = srcs[i] + "?v=" + Date.now(); // bust cache
    s.defer = true;
    s.onload = ()=>console.log("html5-qrcode cargado desde CDN:", s.src);
    s.onerror= ()=>{ if(++i<srcs.length) add(); };
    document.head.appendChild(s);
  }
  add();
})();
</script>

<script>
/* ---------- Config ---------- */
const TOKENS_URL = "./tokens.json"; // en el mismo repo/carpeta

/* ---------- Estado ---------- */
let html5 = null, cams = [], camIdx = 0, last = "", lastAt = 0;
let allowMap = {};            // tokens del repo: {TOKEN: true/false}
let usedLocal = {};           // usados en este navegador
const $ = sel => document.querySelector(sel);
const out = (m,c="ok")=> $("#out").className="status "+c, $("#out").textContent=m;

/* ---------- Utilidades ---------- */
function blobDownload(el, name, text){
  el.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
  el.download = name;
}
function refreshDownloads(){
  const j = JSON.stringify(usedLocal, null, 2);
  blobDownload($("#dl-used-json"), "usados-local.json", j);
  const csv = "token,usado_local\n" + Object.keys(usedLocal).map(t=>`${t},SI`).join("\n");
  blobDownload($("#dl-used-csv"), "usados-local.csv", csv);
}
async function waitForLib(timeout=5000){
  const t0=Date.now();
  while (!window.Html5Qrcode) {
    if (Date.now()-t0 > timeout) throw new Error("Librer√≠a de QR no se carg√≥");
    await new Promise(r=>setTimeout(r,100));
  }
}

/* ---------- Cargar tokens.json ---------- */
async function loadTokens(){
  // cache-busting para evitar cach√© agresiva de Safari/GitHub
  const url = TOKENS_URL + "?v=" + Date.now();
  const r = await fetch(url, {cache:"no-store"});
  if (!r.ok) throw new Error("No pude leer tokens.json ("+r.status+")");
  const j = await r.json();
  if (!j.tokens || typeof j.tokens!=="object") throw new Error("Formato tokens.json inv√°lido");
  allowMap = j.tokens;
}

/* ---------- Validaci√≥n ---------- */
function validateToken(t){
  const token = String(t||"").trim();
  const exists = Object.prototype.hasOwnProperty.call(allowMap, token);
  if (!exists) return out("‚ùå INV√ÅLIDA (token no listado)","bad");
  const ya = allowMap[token] === true || usedLocal[token] === true;
  if (ya) return out("‚ö†Ô∏è YA utilizada","warn");
  usedLocal[token] = true; // marcar local
  localStorage.setItem("qr_usados", JSON.stringify(usedLocal));
  refreshDownloads();
  return out("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
}

/* ---------- C√°mara ---------- */
async function start(){
  try{
    await waitForLib(); // asegura librer√≠a
    if (!html5) html5 = new Html5Qrcode("reader");
    $("#start").disabled = $("#stop").disabled = $("#flip").disabled = true;

    // iOS: primer intento con facingMode "environment"
    try{
      await html5.start(
        { facingMode: { exact: "environment" } },
        { fps: 12, qrbox: 250 },
        onScanSuccess,
        onScanError
      );
    }catch(_){
      // Fallback: enumerar c√°maras y usar por deviceId
      cams = await Html5Qrcode.getCameras();
      if (!cams.length) throw new Error("No hay c√°mara disponible");
      await html5.start(
        { deviceId: { exact: cams[camIdx].id } },
        { fps: 12, qrbox: 250 },
        onScanSuccess,
        onScanError
      );
    }
    out("C√°mara iniciada","ok");
    $("#stop").disabled = $("#flip").disabled = false;
  }catch(e){
    out("‚ùå No se pudo iniciar la c√°mara: " + e.message, "bad");
  }finally{
    $("#start").disabled = false;
  }
}
async function stop(){
  try{
    await html5?.stop(); await html5?.clear();
    out("C√°mara detenida","warn");
  }catch(_){}
}
async function flip(){
  try{
    cams = cams.length ? cams : await Html5Qrcode.getCameras();
    if (!cams.length) return out("No hay c√°maras","bad");
    camIdx = (camIdx + 1) % cams.length;
    await stop(); await start();
  }catch(e){
    out("‚ö†Ô∏è No se pudo cambiar c√°mara: " + e.message, "warn");
  }
}
function onScanSuccess(text){
  const now = Date.now();
  if (text===last && (now-lastAt)<1500) return; // anti-repetici√≥n
  last = text; lastAt = now;
  validateToken(text);
  try{ navigator.vibrate?.(60); }catch(_){}
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.frequency.value=880; o.start(); setTimeout(()=>{o.stop();ctx.close()},120);
  }catch(_){}
}
function onScanError(_){ /* silenciar errores de frame */ }

/* ---------- Manual ---------- */
$("#manual").addEventListener("keydown", e=>{
  if (e.key==="Enter"){
    e.preventDefault();
    const v = e.target.value.trim();
    if (v) validateToken(v);
    e.target.select();
  }
});

/* ---------- Init ---------- */
(async ()=>{
  try{
    usedLocal = JSON.parse(localStorage.getItem("qr_usados")||"{}");
    refreshDownloads();
    await waitForLib();            // espera librer√≠a
    await loadTokens();            // carga tokens del repo
    out("Librer√≠a y tokens cargados. Listo para escanear.","ok");
    $("#start").disabled = false;  // habilitar botones
  }catch(e){
    out("‚ùå " + e.message, "bad");
  }
})();

$("#start").onclick = start;
$("#stop").onclick  = stop;
$("#flip").onclick  = flip;
</script>
</body>
</html>
