<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lector QR ‚Ä¢ GitHub Pages</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:860px;margin:auto;padding:18px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  #reader{width:100%;min-height:320px;background:#0b1220;border-radius:12px;border:1px dashed #334155}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button,.btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer;text-decoration:none}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ GitHub Pages</h1>

  <div class="card">
    <div id="reader"></div>
    <div class="row">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
      <input id="manual" placeholder="Pegar token y Enter" />
    </div>
    <div id="out"></div>
    <div class="row" style="margin-top:10px">
      <a id="dl-used-json" class="btn" download="usados-local.json">Descargar USADOS (JSON)</a>
      <a id="dl-used-csv"  class="btn" download="usados-local.csv">Descargar USADOS (CSV)</a>
    </div>
    <div style="margin-top:8px;color:#9ca3af;font-size:12px">
      Este sitio lee <code>tokens.json</code> del repo. Los ‚Äúusados‚Äù se guardan localmente (este navegador).
    </div>
  </div>
</div>

<!-- 1) Carga LOCAL (no depende de CDN) -->
<script src="./vendor/html5-qrcode.min.js"></script>

<!-- 2) Fallback a CDN s√≥lo si la local no carg√≥ -->
<script>
(async()=>{
  if(!window.Html5Qrcode){
    const srcs=[
      "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
      "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"
    ];
    for(const u of srcs){
      try{
        await new Promise((res,rej)=>{
          const s=document.createElement("script");
          s.src=u+"?v="+Date.now(); s.defer=true; s.crossOrigin="anonymous";
          s.onload=()=>res(); s.onerror=()=>rej();
          document.head.appendChild(s);
        });
        if(window.Html5Qrcode) break;
      }catch(_){}
    }
  }
  if(!window.Html5Qrcode){
    document.getElementById("out").innerHTML =
      '<div class="status bad">‚ùå Librer√≠a de QR no se carg√≥ (usa la versi√≥n LOCAL en <code>/vendor/</code>).</div>';
  }
})();
</script>

<script>
const TOKENS_URL = "./tokens.json";
let html5=null, cameras=[], camIdx=0, last="", lastAt=0;
let allowMap={}, usedLocal={};

const out=(m,c)=>document.getElementById("out").innerHTML=`<div class="status ${c}">${m}</div>`;

async function loadTokens(){
  const r=await fetch(TOKENS_URL,{cache:"no-store"});
  if(!r.ok) throw new Error("No pude leer tokens.json ("+r.status+")");
  const j=await r.json();
  if(!j.tokens||typeof j.tokens!=="object") throw new Error("Formato inv√°lido");
  allowMap=j.tokens;
}
function blobDownload(el,name,text){
  el.href=URL.createObjectURL(new Blob([text],{type:"text/plain"}));
  el.download=name;
}
function refreshDownloads(){
  const j=JSON.stringify(usedLocal,null,2);
  blobDownload(document.getElementById("dl-used-json"),"usados-local.json",j);
  const csv="token,usado_local\n"+Object.keys(usedLocal).map(t=>`${t},SI`).join("\n");
  blobDownload(document.getElementById("dl-used-csv"),"usados-local.csv",csv);
}
function validateToken(token){
  token=(token||"").trim(); if(!token) return;
  const exists=Object.prototype.hasOwnProperty.call(allowMap,token);
  if(!exists) return out("‚ùå INV√ÅLIDA (token no est√° en la lista)","bad");
  const yaRepo=allowMap[token]===true, yaLocal=usedLocal[token]===true;
  if(yaRepo||yaLocal) return out("‚ö†Ô∏è YA utilizada","warn");
  usedLocal[token]=true; localStorage.setItem("qr_usados",JSON.stringify(usedLocal)); refreshDownloads();
  out("‚úÖ V√ÅLIDA ‚Ä¢ acceso permitido","ok");
}
function onScanSuccess(text){
  const now=Date.now(); if(text===last&&(now-lastAt)<1500) return; last=text; lastAt=now;
  validateToken(text);
  try{ navigator.vibrate && navigator.vibrate(80); }catch(_){}
}
async function start(){
  try{
    if(!window.Html5Qrcode) throw new Error("Librer√≠a de QR no se carg√≥");
    if(!location.protocol.startsWith("https")) throw new Error("Se requiere HTTPS");
    if(!html5) html5=new Html5Qrcode("reader");
    cameras=await Html5Qrcode.getCameras();
    if(!cameras.length) throw new Error("No hay c√°mara disponible");
    const id=cameras[camIdx]?.id||cameras[0].id;
    await html5.start({deviceId:{exact:id}},{fps:12,qrbox:250},onScanSuccess);
    out("C√°mara iniciada","ok");
  }catch(e){ out("‚ùå No se pudo iniciar la c√°mara: "+e.message,"bad"); }
}
async function stop(){ try{ await html5?.stop(); html5?.clear(); out("C√°mara detenida","warn"); }catch(_){ } }
async function flip(){
  if(!cameras.length) cameras=await Html5Qrcode.getCameras();
  if(!cameras.length) return out("No hay c√°maras","bad");
  camIdx=(camIdx+1)%cameras.length; await stop(); await start();
}
document.getElementById("manual").addEventListener("keydown",e=>{
  if(e.key==="Enter"){ e.preventDefault(); const v=e.target.value.trim(); if(v) validateToken(v); e.target.select(); }
});
document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;
document.getElementById("flip").onclick=flip;

(async()=>{
  try{
    usedLocal=JSON.parse(localStorage.getItem("qr_usados")||"{}");
    refreshDownloads();
    await loadTokens();
    out("Lista de tokens cargada. Listo para escanear.","ok");
  }catch(err){ out("‚ùå Error cargando tokens: "+err.message,"bad"); }
})();
</script>
</body>
</html>
