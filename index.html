<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector QR ‚Ä¢ C√°mara (redirecci√≥n, robusto)</title>
<style>
  :root{color-scheme: dark;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb;margin:0}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-top:16px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:#9ca3af;font-size:12px;margin-top:6px;white-space:pre-wrap}
  .status{margin-top:12px;padding:12px;border-radius:10px;text-align:center;white-space:pre-wrap}
  .ok{background:#022c22;color:#a7f3d0;border:1px solid #065f46}
  .warn{background:#3a1d06;color:#fde68a;border:1px solid #b45309}
  .bad{background:#2b0d0d;color:#fecaca;border:1px solid #991b1b}
  button{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#e5e7eb;cursor:pointer}
  #reader{width:100%;min-height:320px}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∑ Lector QR ‚Ä¢ C√°mara</h1>
  <div class="card">
    <div id="reader"></div>
    <div class="row">
      <button id="start">Iniciar c√°mara</button>
      <button id="stop">Detener</button>
      <button id="flip">Cambiar c√°mara</button>
    </div>
    <div id="diag" class="muted"></div>
  </div>
  <div id="out" class="card"></div>
</div>

<script>
// Tu Web App (Apps Script) /exec:
const VALIDATOR_BASE = "https://script.google.com/macros/s/AKfycbzzVErGOA1V3xU2GVP-_hMB3_mqDvs_DmThbebENA-pAIraagGsWeUmfI7Dq9mhJ33jUA/exec";

// ---------- utilidades UI ----------
function paint(msg, cls){ document.getElementById("out").innerHTML = `<div class="status ${cls}">${msg}</div>`; }
function diag(msg){ const el=document.getElementById("diag"); el.textContent += (el.textContent? "\n":"") + msg; }

// ---------- carga robusta de html5-qrcode ----------
(function loadHtml5QrLib(){
  const urls = [
    "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
    "https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js",
    "https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"
  ];
  let i = 0;
  function tryLoad(){
    if(i >= urls.length){ diag("‚ùå No se pudo cargar html5-qrcode."); paint("‚ùå No se pudo cargar el lector de QR. Revisa conexi√≥n/HTTPS.","bad"); return; }
    const s = document.createElement("script");
    s.src = urls[i]; s.async = true;
    s.onload = ()=>{ diag("‚úÖ html5-qrcode cargado de: " + urls[i]); };
    s.onerror= ()=>{ diag("‚ö†Ô∏è Fall√≥ cargar: " + urls[i]); i++; tryLoad(); };
    document.head.appendChild(s);
  }
  tryLoad();
})();

// espera a que exista Html5Qrcode
function ensureLib(timeout=10000){
  return new Promise((resolve, reject)=>{
    const t0 = Date.now();
    (function wait(){
      if (window.Html5Qrcode) return resolve();
      if (Date.now() - t0 > timeout) return reject(new Error("Librer√≠a html5-qrcode no disponible"));
      setTimeout(wait, 150);
    })();
  });
}

// ---------- construir URL hacia tu validador (SIEMPRE) ----------
function buildValidatorUrl(text){
  const raw = (text||"").trim();

  // Si ya es tu /exec, solo fuerza html=1
  if (/^https?:\/\//i.test(raw)) {
    try{
      const u = new URL(raw);
      const isExec = /script\.google\.com$/.test(u.hostname);
      const paramC = u.searchParams.get("c") || u.searchParams.get("token");
      if (isExec) {
        const sep = raw.includes("?") ? "&" : "?";
        return `${raw}${sep}html=1`;
      }
      if (paramC) {
        return `${VALIDATOR_BASE}?c=${encodeURIComponent(paramC)}&html=1`;
      }
    }catch(_){}
  }

  if (raw.includes("|")) {
    const [n,c] = raw.split("|");
    return `${VALIDATOR_BASE}?n=${encodeURIComponent(n)}&c=${encodeURIComponent(c)}&html=1`;
  }
  if (/(^|[?&])n=.+&c=.+/i.test(raw)) {
    const qs = raw.replace(/^.*\?/,'');
    return `${VALIDATOR_BASE}?${qs}&html=1`;
  }
  // por defecto tratamos el contenido como TOKEN
  return `${VALIDATOR_BASE}?c=${encodeURIComponent(raw)}&html=1`;
}

// Redirecci√≥n directa (evita CORS)
function validate(decoded){
  try{
    const url = buildValidatorUrl(decoded);
    diag("Redirigiendo a:\n" + url);
    window.location.href = url;
  }catch(e){
    paint("‚ùå Error al construir URL: " + e.message, "bad");
  }
}

// ---------- control de c√°mara ----------
let lastText="", lastAt=0, html5QrCode, cameras=[], currentCamIndex=0;

function onScanSuccess(text){
  const now=Date.now();
  if(text===lastText && (now-lastAt)<1500) return; // evita doble
  lastText=text; lastAt=now;
  validate(text);
}

async function start(){
  try{
    if(!window.isSecureContext){
      paint("‚ùå Debes alojar esta p√°gina en HTTPS.", "bad");
      diag("isSecureContext = false"); return;
    }
    await ensureLib(); // <- aqu√≠ evitamos "Html5Qrcode is not defined"

    // pedir permiso anticipado (mejor UX en iOS)
    try{ await navigator.mediaDevices.getUserMedia({ video:true }); diag("Permiso de c√°mara OK."); }
    catch(e){ diag("Permiso preliminar: " + e.name + " - " + e.message); }

    if(!html5QrCode) html5QrCode=new Html5Qrcode("reader");

    // 1) intentar por deviceId
    try{
      cameras = await Html5Qrcode.getCameras();
      diag("C√°maras detectadas: " + (cameras?.length || 0));
    }catch(e){ diag("getCameras error: " + e.message); }

    if (cameras && cameras.length){
      const id=cameras[currentCamIndex]?.id || cameras[0].id;
      try{
        await html5QrCode.start({deviceId:{exact:id}}, {fps:12, qrbox:{width:240,height:240}}, onScanSuccess);
        paint("C√°mara iniciada (deviceId)","ok");
        return;
      }catch(e){
        diag("start(deviceId) fall√≥: " + e.message);
      }
    }

    // 2) fallback iOS: facingMode
    await html5QrCode.start({facingMode:"environment"}, {fps:12, qrbox:{width:240,height:240}}, onScanSuccess);
    paint("C√°mara iniciada (environment)","ok");

  }catch(e){
    paint("‚ùå No se pudo iniciar la c√°mara: " + e.message, "bad");
    diag("Error start(): " + e.name + " - " + e.message);
  }
}

async function stop(){ try{ await html5QrCode?.stop(); paint("C√°mara detenida","warn"); }catch(_){ } }
async function flip(){
  try{
    if(!cameras || !cameras.length){
      cameras = await Html5Qrcode.getCameras();
      if(!cameras || !cameras.length) return paint("No hay c√°maras para cambiar","bad");
    }
    currentCamIndex = (currentCamIndex+1) % cameras.length;
    await stop(); await start();
  }catch(e){
    paint("‚ùå No se pudo cambiar c√°mara: " + e.message, "bad");
  }
}

document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;
document.getElementById("flip").onclick=flip;
</script>
</body>
</html>
